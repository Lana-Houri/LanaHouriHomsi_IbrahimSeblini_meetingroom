# HAProxy Configuration for Meeting Room Services
# Load balancing configuration for microservices

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4096

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Frontend: Main entry point
frontend http_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/meetingroom.pem
    
    # ACLs for routing
    acl is_users_service path_beg /api/users /api/v1/users /api/v2/users
    acl is_rooms_service path_beg /api/rooms /api/v1/rooms /api/v2/rooms
    acl is_bookings_service path_beg /api/bookings /api/v1/bookings /api/v2/bookings
    acl is_reviews_service path_beg /api/reviews /api/v1/reviews /api/v2/reviews
    
    # Route to appropriate backend
    use_backend users_backend if is_users_service
    use_backend rooms_backend if is_rooms_service
    use_backend bookings_backend if is_bookings_service
    use_backend reviews_backend if is_reviews_service
    
    # Default backend
    default_backend default_backend

# Backend: Users Service
backend users_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # Health check
    option forwardfor
    
    # Multiple instances for load balancing
    server users1 users-service-1:5001 check inter 5s fall 3 rise 2
    server users2 users-service-2:5001 check inter 5s fall 3 rise 2
    server users3 users-service-3:5001 check inter 5s fall 3 rise 2 backup

# Backend: Rooms Service
backend rooms_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    option forwardfor
    
    # Multiple instances for load balancing
    server rooms1 rooms-service-1:5000 check inter 5s fall 3 rise 2
    server rooms2 rooms-service-2:5000 check inter 5s fall 3 rise 2
    server rooms3 rooms-service-3:5000 check inter 5s fall 3 rise 2 backup

# Backend: Bookings Service
backend bookings_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    option forwardfor
    
    # Multiple instances for load balancing
    server bookings1 bookings-service-1:5002 check inter 5s fall 3 rise 2
    server bookings2 bookings-service-2:5002 check inter 5s fall 3 rise 2
    server bookings3 bookings-service-3:5002 check inter 5s fall 3 rise 2 backup

# Backend: Reviews Service
backend reviews_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    option forwardfor
    
    # Multiple instances for load balancing
    server reviews1 reviews-service-1:5003 check inter 5s fall 3 rise 2
    server reviews2 reviews-service-2:5003 check inter 5s fall 3 rise 2
    server reviews3 reviews-service-3:5003 check inter 5s fall 3 rise 2 backup

# Default Backend
backend default_backend
    balance roundrobin
    server default localhost:8080

# Statistics and Monitoring
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:admin

